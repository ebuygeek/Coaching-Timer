<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Timer with Alarm</title>
  <style>
    body { font-family: Arial, sans-serif; }
    /* your existing CSS â€¦ */

    #soundToggleBtn {
      position: fixed; /* repositioned by JS */
      background: transparent;
      border: 0;
      font-size: 26px;
      cursor: pointer;
      user-select: none;
      padding: 0;
      margin: 0;
      line-height: 1;
      z-index: 9999;
      text-shadow: 0 0 6px currentColor;
    }
  </style>
</head>
<body>

  <!-- Your existing timer UI â€¦ -->

  <!-- Alarm audio -->
  <audio id="endAlarm" preload="auto" src="alarm.mp3"></audio>

  <!-- Sound toggle button -->
  <button id="soundToggleBtn" title="Toggle sound">ðŸ”Š</button>

  <script>
  // ==== Alarm logic ====
  const endAlarm = document.getElementById('endAlarm');
  let alarmPlayed = false;

  function startTimer() {
    if (remainingSeconds <= 0) return;
    // Reset alarm flag and prime audio on Start
    alarmPlayed = false;
    try {
      var primed = endAlarm && endAlarm.play && endAlarm.play();
      if (primed && typeof primed.then === 'function') {
        primed.then(function(){ endAlarm.pause(); endAlarm.currentTime = 0; }).catch(function(){});
      }
    } catch(e) {}
    // existing start logic...
  }

  function resetTimer() {
    stopTimer();
    // Reset alarm audio/flag
    try { if (endAlarm) { endAlarm.pause(); endAlarm.currentTime = 0; } } catch(e) {}
    alarmPlayed = false;
    // existing reset logic...
  }

  // Hook your existing tick / countdown logic:
  // when remainingSeconds hits 0, play alarm once
  function tick() {
    remainingSeconds--;
    if (remainingSeconds === 0 && !alarmPlayed) {
      alarmPlayed = true;
      try {
        if (!endAlarm.muted) {
          var p = endAlarm.play();
          if (p && typeof p.catch === 'function') { p.catch(function(){}); }
        }
      } catch(e){}
    }
    updateTimerDisplay();
  }

  // ==== Preset override (top preset = 1 minute) ====
  (function(){
    try {
      if (typeof presets !== 'undefined') {
        presets.top = { connect: 1, outcome: 0, awareness: 0, course: 0, highlights: 0 };
      }
      var btnTop = document.getElementById('preset-top');
      if (btnTop) {
        btnTop.addEventListener('click', function(ev){
          if (ev && ev.stopImmediatePropagation) ev.stopImmediatePropagation();
          if (ev && ev.stopPropagation) ev.stopPropagation();
          if (typeof stopTimer === 'function') stopTimer();
          var set = function(id, v){
            var el = (typeof inputs !== 'undefined' && inputs[id]) ? inputs[id] : document.getElementById(id);
            if (el) el.value = v;
          };
          set('connect', 1); set('outcome', 0); set('awareness', 0); set('course', 0); set('highlights', 0);
          if (typeof recalcTimer === 'function') recalcTimer();
        }, true); // capture phase
      }
    } catch(e) {}
  })();

  // ==== Sound toggle logic ====
  (function(){
    var btn = document.getElementById('soundToggleBtn');
    var timerBox = document.getElementById('timerContainer');
    var orangeBox = document.querySelector('#themePresetsColumn .theme-box[data-theme="#FFA500"]');

    function syncColor(){
      try {
        var timerDisplay = document.getElementById('timerDisplay');
        if (!timerDisplay) return;
        var cs = window.getComputedStyle(timerDisplay);
        btn.style.color = cs.color; // match theme color
        btn.style.filter = 'drop-shadow(0 0 4px ' + cs.color + ')';
      } catch(e){}
    }

    function renderIcon(){
      btn.textContent = endAlarm.muted ? "ðŸ”‡" : "ðŸ”Š";
    }

    btn.addEventListener('click', function(){
      endAlarm.muted = !endAlarm.muted;
      renderIcon();
    });

    function findLowestElementBottom(){
      var nodes = document.body.getElementsByTagName('*');
      var maxBottom = 0;
      for (var i=0;i<nodes.length;i++){
        var r = nodes[i].getBoundingClientRect();
        if (r.bottom > maxBottom) maxBottom = r.bottom;
      }
      return maxBottom;
    }

    function place(){
      if (!timerBox) return;
      var t = timerBox.getBoundingClientRect();
      var orange = orangeBox ? orangeBox.getBoundingClientRect() : null;
      var btnRect = btn.getBoundingClientRect();
      var left = t.right - btnRect.width - 6;
      var bottomRef = orange ? orange.bottom : findLowestElementBottom();
      var top  = bottomRef - btnRect.height - 6;
      btn.style.left = Math.max(2, left) + 'px';
      btn.style.top  = Math.max(2, top) + 'px';
    }

    window.addEventListener('resize', function(){ place(); syncColor(); });
    setTimeout(function(){ place(); syncColor(); renderIcon(); }, 0);

    // Hook into updateTimerDisplay if available
    if (typeof updateTimerDisplay === 'function') {
      var _u = updateTimerDisplay;
      window.updateTimerDisplay = function(){
        var r = _u.apply(this, arguments);
        syncColor();
        return r;
      };
    }
  })();
  </script>
</body>
</html>
